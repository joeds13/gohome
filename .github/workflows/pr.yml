name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: "1.21"

jobs:
  validate:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Check formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files are not properly formatted:"
            gofmt -s -l .
            exit 1
          fi

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

  build-test:
    name: Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        run: |
          CGO_ENABLED=0 go build -o gohome ./cmd/main.go
          ./gohome --help || true  # Test basic execution

      - name: Build for multiple architectures
        run: |
          GOOS=linux GOARCH=amd64 go build -o gohome-linux-amd64 ./cmd/main.go
          GOOS=linux GOARCH=arm64 go build -o gohome-linux-arm64 ./cmd/main.go
          GOOS=darwin GOARCH=amd64 go build -o gohome-darwin-amd64 ./cmd/main.go
          GOOS=darwin GOARCH=arm64 go build -o gohome-darwin-arm64 ./cmd/main.go

  docker-test:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: gohome:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm gohome:test --help || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: ./...

      - name: Run Nancy vulnerability scanner
        run: |
          go list -json -deps ./... | docker run --rm -i sonatypecommunity/nancy:latest sleuth

  kubernetes-validate:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Validate Kubernetes manifests
        run: |
          # Validate YAML syntax
          for file in k8s/*.yaml; do
            echo "Validating $file"
            kubectl apply --dry-run=client --validate=true -f "$file" || exit 1
          done

      - name: Run kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          chmod +x kubeval
          ./kubeval k8s/*.yaml

      - name: Check for hardcoded secrets
        run: |
          if grep -r "password\|secret\|key" k8s/ --include="*.yaml" | grep -v "name:"; then
            echo "Potential hardcoded secrets found in manifests!"
            exit 1
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | wc -l)
          CHANGED_LINES=$(git diff --stat origin/main...HEAD | tail -n1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc || echo 0)

          echo "Changed files: $CHANGED_FILES"
          echo "Changed lines: $CHANGED_LINES"

          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "‚ö†Ô∏è  Large PR: $CHANGED_FILES files changed. Consider breaking this into smaller PRs."
          fi

          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "‚ö†Ô∏è  Large PR: $CHANGED_LINES lines changed. Consider breaking this into smaller PRs."
          fi

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for documentation updates
        run: |
          # Check if Go files were modified but README wasn't updated
          if git diff --name-only origin/main...HEAD | grep -E '\.(go)$' > /dev/null; then
            if ! git diff --name-only origin/main...HEAD | grep -E '(README\.md|\.md)$' > /dev/null; then
              echo "üìù Consider updating documentation for code changes"
            fi
          fi

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "yes"
          config-file: ".github/markdown-link-check-config.json"
        continue-on-error: true

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs:
      [validate, build-test, docker-test, security-scan, kubernetes-validate]
    if: always()

    steps:
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## PR Validation Results')
            );

            const results = {
              validate: '${{ needs.validate.result }}',
              build: '${{ needs.build-test.result }}',
              docker: '${{ needs.docker-test.result }}',
              security: '${{ needs.security-scan.result }}',
              kubernetes: '${{ needs.kubernetes-validate.result }}'
            };

            const getEmoji = (result) => {
              switch(result) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'cancelled': return '‚è∏Ô∏è';
                default: return '‚è≥';
              }
            };

            const body = `## PR Validation Results

            | Check | Status | Result |
            |-------|---------|---------|
            | Code Quality & Tests | ${getEmoji(results.validate)} | ${results.validate} |
            | Build Test | ${getEmoji(results.build)} | ${results.build} |
            | Docker Build | ${getEmoji(results.docker)} | ${results.docker} |
            | Security Scan | ${getEmoji(results.security)} | ${results.security} |
            | Kubernetes Validation | ${getEmoji(results.kubernetes)} | ${results.kubernetes} |

            ${Object.values(results).every(r => r === 'success') ?
              'üéâ All checks passed! This PR is ready for review.' :
              '‚ö†Ô∏è Some checks failed. Please review the logs and fix any issues.'
            }

            ---
            *Updated: ${new Date().toISOString()}*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
